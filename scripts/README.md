# Скрипты для управления базой данных

## clearAllDataExceptUsers.js

Скрипт для полной очистки базы данных с сохранением пользователей.

### Что удаляется:

- ✅ Расписания и занятия
- ✅ Конфликты и история оптимизации
- ✅ Группы и подгруппы
- ✅ Учебная нагрузка
- ✅ Образовательные программы
- ✅ Кафедры и факультеты
- ✅ Дисциплины и учебные планы
- ✅ Семестры
- ✅ Корпуса и аудитории
- ✅ Временные слоты
- ✅ Ограничения и настройки
- ✅ Уведомления

### Что НЕ удаляется:

- ❌ Пользователи (users)
- ❌ Профили пользователей (student_profiles, teacher_profiles, dispatcher_profiles, admin_profiles)

### Использование:

#### Вариант 1: Через Node.js (рекомендуется)

```bash
cd server
node scripts/clearAllDataExceptUsers.js
```

Скрипт попросит подтверждение перед удалением.

#### Вариант 2: Прямой SQL запрос

```bash
cd server
mysql -u root -p schedule_ai < clear_all_data_except_users.sql
```

### ⚠️ ВАЖНО:

1. **Создайте резервную копию** перед использованием:
   ```bash
   mysqldump -u root -p schedule_ai > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **Убедитесь**, что база данных настроена правильно в `.env`:
   ```
   DATABASE_URL="mysql://user:password@localhost:3306/schedule_ai"
   ```

3. Операция **необратима** - все данные будут удалены безвозвратно!

### Примеры использования:

#### Полная очистка для тестирования:
```bash
# 1. Создаем backup
mysqldump -u root -p schedule_ai > backup.sql

# 2. Очищаем данные
node scripts/clearAllDataExceptUsers.js

# 3. Импортируем тестовые данные
node prisma/seed.js
```

#### Очистка перед новым семестром:
```bash
# Очищаем старые расписания, но сохраняем структуру и пользователей
node scripts/clearAllDataExceptUsers.js

# Импортируем новые данные из Excel
# Используйте функцию импорта в интерфейсе
```

### Восстановление из backup:

Если что-то пошло не так:

```bash
# Восстановление из резервной копии
mysql -u root -p schedule_ai < backup.sql
```

### Порядок удаления (автоматический):

Скрипт автоматически удаляет данные в правильном порядке с учетом внешних ключей:

1. Конфликты и оптимизация
2. Расписания и уроки
3. Ограничения и настройки
4. Учебная нагрузка и подгруппы
5. Группы и учебные планы
6. Образовательные программы
7. Кафедры
8. Факультеты
9. Дисциплины
10. Семестры
11. Аудитории и корпуса
12. Временные слоты
13. Уведомления

### Логирование:

Скрипт выводит подробную информацию:
- Количество удаленных записей для каждой таблицы
- Общее количество удаленных записей
- Статистику оставшихся пользователей

### Безопасность:

- ✅ Запрашивает подтверждение перед удалением
- ✅ Использует транзакции Prisma
- ✅ Автоматически отключает/включает проверку внешних ключей
- ✅ Корректно закрывает соединение с БД

### Troubleshooting:

**Ошибка: Foreign key constraint fails**
- Убедитесь, что используется скрипт, а не прямое удаление
- Скрипт автоматически управляет FOREIGN_KEY_CHECKS

**Ошибка: Cannot connect to database**
- Проверьте DATABASE_URL в .env
- Убедитесь, что MySQL сервер запущен
- Проверьте права доступа пользователя БД

**Ошибка: Module not found**
- Выполните: `npm install` в директории server
- Проверьте, что вы в правильной директории

### Альтернативы:

Если нужно удалить только определенные данные:

```javascript
// Удалить только расписания
await prisma.schedule.deleteMany()

// Удалить только группы определенного года
await prisma.group.deleteMany({
  where: { enrollmentYear: 2023 }
})

// Удалить неактивные программы
await prisma.educationalProgram.deleteMany({
  where: { isActive: false }
})
```

